# 서버의 CPU 코어에 맞춰 자동으로 프로세스 설정
worker_processes auto;

events {
    # 각 워커 프로세스당 최대 동시 접속 수
    worker_connections 1024;
}

http {
    charset utf-8;

    upstream admin_backend {
        # 실제 애플리케이션 서버 (컨테이너명:포트)
        server admin-app:9091;
        # upstream과의 연결을 재사용해 연결 생성 비용 절감 (SSE 안정성 향상)
        keepalive 32;
    }

    server {
        listen 80;
        server_name admin.kyj2579.com;

        # SSE(Server-Sent Events) 전용 엔드포인트
        location /api/v1/notifications/subscribe {
            proxy_pass http://admin_backend;

            # 요청 본문을 버퍼링하지 않고 즉시 전달
            proxy_request_buffering off;
            # 응답 데이터를 버퍼링하지 않고 클라이언트에 즉시 전송 (SSE 핵심)
            proxy_buffering off;
            # 프록시 캐시 비활성화 (실시간 데이터이므로 캐싱 불필요)
            proxy_cache off;

            # HTTP/1.1 사용 (keep-alive 및 청크 전송 지원)
            proxy_http_version 1.1;
            # Connection 헤더 제거 → upstream과 keep-alive 유지
            proxy_set_header Connection '';

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;

            # 브라우저에 캐시하지 말 것을 지시
            add_header Cache-Control no-cache;
            # Nginx 버퍼링 강제 비활성화 (리버스 프록시 체인에서도 적용)
            add_header X-Accel-Buffering no;

            # SSE는 장시간 연결 유지가 필요하므로 타임아웃을 1시간으로 연장
            proxy_read_timeout 3600s;      # 서버 응답 대기 시간
            proxy_send_timeout 3600s;      # 클라이언트로 전송 대기 시간
            proxy_connect_timeout 3600s;   # upstream 연결 수립 대기 시간
        }

        # 일반 API 요청 처리
        location / {
            proxy_pass http://admin_backend;

            # HTTP/1.1 + keep-alive로 upstream 연결 재사용
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            # 클라이언트 실제 IP 체인 전달 (프록시 경유 시에도 추적 가능)
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # 원본 프로토콜 전달 (http/https 구분)
            proxy_set_header X-Forwarded-Proto $scheme;

            # 리다이렉트 URL을 그대로 클라이언트에 전달
            proxy_redirect off;
        }
    }
}